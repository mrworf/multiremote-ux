<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content='maximum-scale=1.0, initial-scale=1.0, width=device-width' name='viewport'>
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>multiREMOTE</title>

    <!-- Bootstrap core CSS -->
    <link href="dependencies/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="index.css" rel="stylesheet">
  </head>

  <body>
    <div id="blockui"></div>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">multiREMOTE</a>
        <ul class="nav navbar-nav" id="zone-list">
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#"><span class="glyphicon glyphicon-off"></span> All off</a></li>
        </ul>
      </div>
    </nav>

    <div class="container" id="canvas">
    </div> <!-- /container -->


    <!-- Working indicator -->
    <div style="width: 50%; height: 58px; overflow: hidden; padding: 2px; margin: auto; background: #ffffff; border: 2px outset" class="modal fade" id="busyIndicator" data-backdrop="static" data-keyboard="false">
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="font-size: 18px; width:100%">...Please wait...</div>
        </div>
      </div>
    </div>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="dependencies/jquery2.min.js"></script>
    <script src="dependencies/bootstrap/js/bootstrap.min.js"></script>
    <script src="multiremoteclient.js"></script>
    <script src="multiremotetypes.js"></script>
    <script src="buttonrepeater.js"></script>
    <script src="resultwrapper.js"></script>
    <script src="ux-objects.js"></script>
    <script type="text/javascript">
      var ux = new UXObjects();
      var result = new ResultWrapper(ux, 500);
      var app = new MultiRemoteClient("magi.sfo.sensenet.nu", function(a,b,c){result.handler(a,b,c);});

      ux.optimize();

      function sceneHandler(command) {
        ux.vibrate(ux.VIBRATE_BTN);
        console.log("Command = " + command);

        result.wrap(function(){return app.issueCommand("scene", command);}, function(success, data) {
          console.log("Command returned");
        }, true);
      }

      function zoneHandler(command) {
        ux.vibrate(ux.VIBRATE_BTN);
        console.log("Command = " + command);

        result.wrap(function(){return app.issueCommand("zone", command);}, function(success, data) {
          console.log("Command returned");
        }, true);
      }

      function appHandler(packagename) {
        ux.vibrate(ux.VIBRATE_BTN);
        ux.launchPackage(packagename);
      }

      function selectScene(scene) {
        ux.vibrate(ux.VIBRATE_BTN);

        result.wrap(function(){return app.selectScene(scene);}, function(success, data) {
          // Alright! Now we need represent this somehow... this is what we've all been waiting for!
          if (scene != null) {
            showCommands();
          } else {
            showScenes();
          }
        }, true);
      }

      function gotoStandby() {
        selectScene(null);
      }

      function showCommands() {
        result.wrap(function(){return app.getCommands();}, function(success, data) {
          // Lets see what we got
          ux.clearCanvas();
          ux.renderSceneInfo(app.getScene(app.getCachedScene()), gotoStandby, showScenes);
          ux.createVolumeControls(data.zone, zoneHandler);
          ux.createPlaybackControls(data.scene, sceneHandler);
          ux.createNavigationControls(data.scene, sceneHandler);
          ux.createApplicationLink(app.getScene(app.getCachedScene()), appHandler);
        }, true);
      }

      function showScenes() {
        scenes = app.getScenesForZone(app.getCachedZone());
        ux.clearCanvas();
        ux.createSceneSelector(scenes, app.getCachedScene(), selectScene);
      }

      function selectZone(zone, subzone) {
        ux.vibrate(ux.VIBRATE_BTN);

        result.wrap(function(){return app.selectZone(zone);}, function(success, data) {
          // Find out which scene we're using for this zone
          ux.highlightZone(zone);
          result.wrap(function(){return app.getActiveScene();}, function(success, data) {
            if (data == null) {
              showScenes();
            } else {
              showCommands();
            }
          }, true);
        }, true);
      }

      // init the client and remove the modal once done
      result.wrap(function(){return app.init();}, function() {
        z = app.getZones();
        for (var e in z) {
          if (z.hasOwnProperty(e)) {
            if (app.hasSubZones(e))
              ux.addSubZone(z[e], e, app.getSubZones(e), selectZone);
            else
              ux.addZone(z[e], e, selectZone);
          }
        }
      }, true);
    </script>
  </body>
</html>
