<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content='maximum-scale=1.0, initial-scale=1.0, width=device-width' name='viewport'>
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>multiREMOTE</title>

    <!-- Bootstrap core CSS -->
    <link href="dependencies/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="index.css" rel="stylesheet">
  </head>

  <body>
    <div id="blockui"></div>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">multiREMOTE</a>
        <ul class="nav navbar-nav" id="zone-list">
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#"><span class="glyphicon glyphicon-off"></span> All off</a></li>
        </ul>
      </div>
    </nav>

    <div class="container" id="canvas">
    </div> <!-- /container -->


    <!-- Working indicator -->
    <div style="width: 50%; height: 58px; overflow: hidden; padding: 2px; margin: auto; background: #ffffff; border: 2px outset" class="modal fade" id="busyIndicator" data-backdrop="static" data-keyboard="false">
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="font-size: 18px; width:100%">...Please wait...</div>
        </div>
      </div>
    </div>

    <div style="width: 50%; height: 80%; overflow: hidden; padding: 2px; margin: auto; background: #ffffff; border: 2px outset" class="modal fade" id="conflictResolution" data-backdrop="static" data-keyboard="false">
      <div class="modal-body">
        <span id="resolve-question">X conflicts with Y, how would you like to resolve this?</span>
        <hr>
        Resolve by...
        <button id="resolve-cancel" type="button" style="margin-top: 10px; width: 100%" class="btn btn-default btn-lg">Cancel selection</button>
        <button id="resolve-clone" type="button" style="margin-top: 10px; width: 100%" class="btn btn-primary btn-lg">Play on both</button>
        <button id="resolve-unassign" type="button" style="margin-top: 10px; width: 100%" class="btn btn-warning btn-lg">Transfer here</button>
      </div>
    </div>

    <div style="width: 50%; overflow-x: hidden; overflow-y: auto; max-height: 80%; padding: 2px; margin: auto; background: #ffffff; border: 2px outset" class="modal fade" id="configDialog" data-backdrop="static" data-keyboard="false">
      <div class="modal-body">
        Please configure this remote
        <hr>
        <div class="input-group" style="width: 100%">
          <label for="config-name">Name</label>
          <input id="config-name" type="text" class="form-control" placeholder="Short and nice" aria-describedby="basic-addon1">
        </div>
        <div class="input-group" style="width: 100%">
          <label for="config-desc">Description</label>
          <input id="config-desc" type="text" class="form-control" placeholder="For example: location, device, owner" aria-describedby="basic-addon1">
        </div>
        <div class="input-group" style="width: 100%">
          <label for="config-zone">Default location</label>
          <select id="config-zone" class="form-control" aria-describedby="basic-addon1"></select>
        </div>
        <div class="input-group" style="width: 100%">
          <label for="config-pin">System PIN</label>
          <input id="config-pin" type="password" class="form-control" placeholder="Provided by the installer" aria-describedby="basic-addon1">
        </div>
        <button id="config-add" type="button" style="margin-top: 10px; width: 100%" class="btn btn-primary btn-lg">Add remote</button>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="dependencies/jquery2.min.js"></script>
    <script src="dependencies/bootstrap/js/bootstrap.min.js"></script>
    <script src="dependencies/json2.js"></script>
    <script src="dependencies/jstorage.js"></script>
    <script src="multiremoteclient.js"></script>
    <script src="multiremotetypes.js"></script>
    <script src="buttonrepeater.js"></script>
    <script src="resultwrapper.js"></script>
    <script src="ux-objects.js"></script>
    <script type="text/javascript">
      var ux = new UXObjects();
      var result = new ResultWrapper(ux, 500);
      var app = new MultiRemoteClient("magi.sfo.sensenet.nu", function(a,b,c){result.handler(a,b,c);});

      ux.optimize();

      function sceneHandler(command) {
        ux.vibrate(ux.VIBRATE_BTN);

        result.wrap(function(){return app.issueCommand("scene", command);}, function(success, data) {
        }, true);
      }

      function zoneHandler(command) {
        ux.vibrate(ux.VIBRATE_BTN);

        result.wrap(function(){return app.issueCommand("zone", command);}, function(success, data) {
        }, true);
      }

      function appHandler(packagename) {
        ux.vibrate(ux.VIBRATE_BTN);
        ux.launchPackage(packagename);
      }

      function conflictHandler(scene, choice) {
        // In most cases, you can just send the choice back...
        ux.vibrate(ux.VIBRATE_BTN);

        if (choice == "clone") {
          selectScene(scene, "clone");
        } else if (choice == "unassign") {
          selectScene(scene, "unassign");
        } else {

        }
      }

      function configHandler(pin, name, desc, zone) {
        ux.vibrate(ux.VIBRATE_BTN);

        result.wrap(function() {return app.registerRemote(pin, name, desc, zone);}, function(success, data) {
          if (!success) {
            ux.showConfiguration(app.getZones(), configHandler, true);
          } else {
            // Woohoo! Load default zone
            selectZone(app.getDefaultZone());
          }
        });
      }

      function selectScene(scene, override) {
        // Override is never set when called directly
        if (undefined == override)
          ux.vibrate(ux.VIBRATE_BTN);

        result.wrap(function(){return app.selectScene(scene, override);}, function(success, data) {
          // Alright! Now we need represent this somehow... this is what we've all been waiting for!
          if (success) {
            if (scene != null) {
              showCommands();
            } else {
              showScenes();
            }
          } else {
            // Something went wrong...
            if (data.hasOwnProperty("conflict")) {
              // It's a conflict, show some reasonable error...
              var want = app.getScene(scene).name;
              var question = "Choosing " + want + " could conflict with ";
              var count = data.conflict.length;
              for(var z in data.conflict) {
                question += app.getZone(data.conflict[z]).name
                if (count == 2) {
                  question += " and ";
                } else if (count > 2) {
                  question += ", ";
                }
                count--;
              }
              ux.showConflict(scene, question, data.conflict.length, conflictHandler);
            }
          }
        }, true);
      }

      function gotoStandby() {
        selectScene(null);
      }

      function showCommands() {
        result.wrap(function(){return app.getCommands();}, function(success, data) {
          // Lets see what we got
          ux.clearCanvas();
          ux.renderSceneInfo(app.getScene(app.getCachedScene()), gotoStandby, showScenes);
          ux.createVolumeControls(data.zone, zoneHandler);
          ux.createPlaybackControls(data.scene, sceneHandler);
          ux.createNavigationControls(data.scene, sceneHandler);
          ux.createApplicationLink(app.getScene(app.getCachedScene()), appHandler);
          ux.renderSceneIcon(app.getScene(app.getCachedScene()));
        }, true);
      }

      function showScenes() {
        scenes = app.getScenesForZone(app.getCachedZone());
        ux.clearCanvas();
        ux.createSceneSelector(scenes, app.getCachedScene(), selectScene);
      }

      function selectZone(zone, subzone) {
        ux.vibrate(ux.VIBRATE_BTN);

        result.wrap(function(){return app.selectZone(zone);}, function(success, data) {
          // Find out which scene we're using for this zone
          ux.highlightZone(zone);
          result.wrap(function(){return app.getActiveScene();}, function(success, data) {
            if (data == null) {
              showScenes();
            } else {
              showCommands();
            }
          }, true);
        }, true);
      }

      // init the client and remove the modal once done
      result.wrap(function(){return app.init();}, function() {
        z = app.getZones();
        for (var e in z) {
          if (z.hasOwnProperty(e)) {
            if (app.hasSubZones(e))
              ux.addSubZone(z[e], e, app.getSubZones(e), app.getActiveSubZone(e), selectZone);
            else
              ux.addZone(z[e], e, selectZone);
          }
        }

        // Do we have a remote?
        if (!app.isRegistered()) {
          ux.showConfiguration(app.getZones(), configHandler, false);
        } else {
          selectZone(app.getDefaultZone());
        }
      }, true);
    </script>
  </body>
</html>
